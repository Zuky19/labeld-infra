name: Reusable Gitleaks Scan

on:
  workflow_call:

# Required permission for SARIF uploads
permissions:
  security-events: write

jobs:
  gitleaks-scan:
    name: Reusable Gitleaks Scan
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Install Gitleaks manually
      - name: Install Gitleaks
        run: |
          curl -sSL https://github.com/zricethezav/gitleaks/releases/download/v8.16.1/gitleaks_8.16.1_linux_x64.tar.gz | tar -xz -C /tmp
          chmod +x /tmp/gitleaks

      # Step 3: Run Gitleaks and output SARIF to repo root
      - name: Run Gitleaks
        run: |
          /tmp/gitleaks detect \
            --source ${{ github.workspace }} \
            --report-format sarif \
            --report-path ${{ github.workspace }}/gitleaks.sarif \
            --redact \
            --exit-code=0 \
            --log-level=debug

      # Step 4: Upload SARIF to GitHub Security
      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ github.workspace }}/gitleaks.sarif

